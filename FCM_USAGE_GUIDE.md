# ุฏููู ุงุณุชุฎุฏุงู FCM ููุฅุดุนุงุฑุงุช

## โ ุชู ุฅูุฌุงุฒ ุฌููุน ุงูุชุญุฏูุซุงุช ุงููุทููุจุฉ!

### ๐ฏ **ูุง ุชู ุชุทุจููู:**

#### **1. ูุงุนุฏุฉ ุงูุจูุงูุงุช:**
- โ **FCM tokens ูุญููุธุฉ ููู ูุณุชุฎุฏู** ูู Firestore
- โ **ุญููู ุฅุถุงููุฉ**: `lastTokenUpdate`, `deviceInfo`
- โ **ุชุญุฏูุซ ุชููุงุฆู** ุนูุฏ ุชุณุฌูู ุงูุฏุฎูู/ุงูุชุณุฌูู

#### **2. ุฎุฏูุงุช ุฌุฏูุฏุฉ:**
- โ **UpdateUsersFCMService**: ูุชุญุฏูุซ ุงููุณุชุฎุฏููู ุงูุญุงูููู
- โ **FirebaseNotificationService**: ูุญุณู ูุญูุธ tokens ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ **ูุฑุงูุจุฉ ุชุญุฏูุซ tokens**: ุชููุงุฆูุงู

#### **3. ูุงุฌูุฉ ุงููุณุชุฎุฏู:**
- โ **ุฒุฑ ูู ุตูุญุฉ ุงููุณุชุฎุฏู**: ูุชุญุฏูุซ ุฌููุน ุงููุณุชุฎุฏููู
- โ **ุชุฃููุฏ ูุจู ุงูุชุญุฏูุซ**: dialog ููุชุฃููุฏ
- โ **ูุคุดุฑ ุงูุชุญููู**: ุฃุซูุงุก ุงูุชุญุฏูุซ

## ๐ **ููููุฉ ุงุณุชุฎุฏุงู ุงููุธุงู:**

### **ุงูุฎุทูุฉ 1: ุชุญุฏูุซ ุงููุณุชุฎุฏููู ุงูุญุงูููู**
1. **ุงูุชุญ ุงูุชุทุจูู**
2. **ุณุฌู ุฏุฎููู**
3. **ุงุฐูุจ ุฅูู ุตูุญุฉ ุงูููู ุงูุดุฎุตู** (ุฃููููุฉ ุงูุญุณุงุจ)
4. **ุงุถุบุท ุนูู "ุชุญุฏูุซ ุฅุดุนุงุฑุงุช ุฌููุน ุงููุณุชุฎุฏููู"**
5. **ุฃูุฏ ุงูุนูููุฉ**
6. **ุงูุชุธุฑ ุญุชู ููุชูู ุงูุชุญุฏูุซ**

### **ุงูุฎุทูุฉ 2: ุฅุฑุณุงู ุงูุฅุดุนุงุฑุงุช**
#### **ุงูุทุฑููุฉ ุงูุฃููู: Firebase Console (ุงูุฃุณูู)**
1. ุงุฐูุจ ุฅูู [Firebase Console](https://console.firebase.google.com)
2. ุงุฎุชุฑ ูุดุฑูุนู
3. ุงุฐูุจ ุฅูู **Cloud Messaging**
4. ุงุถุบุท **"Send your first message"**
5. ูู **Target** โ ุงุฎุชุฑ **"Topic"**
6. ุงูุชุจ: `online_players`
7. ุงูุชุจ ุงูุนููุงู ูุงููุต
8. ุงุถุบุท **"Review"** ุซู **"Publish"**

#### **ุงูุทุฑููุฉ ุงูุซุงููุฉ: Firebase Functions (ูุชูุฏู)**
```javascript
const functions = require('firebase-functions');
const admin = require('firebase-admin');

exports.sendOnlineNotification = functions.https.onRequest(async (req, res) => {
  try {
    // ุฌูุจ ุฌููุน FCM tokens
    const usersSnapshot = await admin.firestore()
      .collection('users')
      .where('fcmToken', '!=', null)
      .get();

    const tokens = [];
    usersSnapshot.forEach(doc => {
      const token = doc.data().fcmToken;
      if (token && token !== 'pending_token_update') {
        tokens.push(token);
      }
    });

    // ุฅุฑุณุงู ุงูุฅุดุนุงุฑุงุช
    const message = {
      notification: {
        title: 'ุงููุญูููู - ุงููุนุจ ุงูุฃูููุงูู ๐ฎ',
        body: 'ูุงุนุจูู ููุชุธุฑููู! ุชุญุฏุงูู ุงูุขู ูู ุงููุจุงุฑูุงุช ุงูุฃูููุงูู โฝ๐ฅ'
      },
      tokens: tokens
    };

    const response = await admin.messaging().sendMulticast(message);
    console.log(`ุชู ุฅุฑุณุงู ${response.successCount} ุฅุดุนุงุฑ ุจูุฌุงุญ`);
    
    res.json({ success: true, sent: response.successCount });
  } catch (error) {
    console.error('ุฎุทุฃ:', error);
    res.status(500).json({ error: error.message });
  }
});
```

## ๐ **ุญุงูุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช:**

### **ุจุนุฏ ุงูุชุญุฏูุซ ุณุชุฌุฏ:**
```json
// ูุฌููุนุฉ users
users: {
  "userId1": {
    "email": "user1@example.com",
    "playerName": "ุฃุญูุฏ",
    "points": 100,
    "fcmToken": "actual_fcm_token_here",
    "lastTokenUpdate": "2024-01-01T12:00:00Z",
    "deviceInfo": {
      "platform": "android",
      "lastActive": "2024-01-01T12:00:00Z",
      "tokenStatus": "active"
    }
  },
  "userId2": {
    "email": "user2@example.com", 
    "playerName": "ุณุงุฑุฉ",
    "points": 50,
    "fcmToken": "another_fcm_token_here",
    "lastTokenUpdate": "2024-01-01T12:00:00Z",
    "deviceInfo": {
      "platform": "android",
      "lastActive": "2024-01-01T12:00:00Z",
      "tokenStatus": "active"
    }
  }
}
```

## ๐ฎ **ุฑุณุงุฆู ุงูุฅุดุนุงุฑุงุช ุงูููุชุฑุญุฉ:**

### **ุฑุณุงุฆู ุชุญููุฒูุฉ ููุนุจ ุงูุฃูููุงูู:**
1. **"ูุงุนุจูู ููุชุธุฑููู! ุชุญุฏุงูู ุงูุขู ูู ุงููุจุงุฑูุงุช ุงูุฃูููุงูู โฝ๐ฅ"**
2. **"ูู ุฃูุช ุฌุงูุฒ ููุชุญุฏูุ ุงูุนุจ ุฃูููุงูู ูุฃุซุจุช ุฃูู ุงูุฃูุถู! ๐โฝ"**
3. **"ูุจุงุฑุงุฉ ุณุฑูุนุฉุ ุงูุถู ููุงุนุจูู ุงูุขู ูุงุจุฏุฃ ุงูุชุญุฏู! ๐ฏโฝ"**
4. **"ุฃุธูุฑ ููุงุฑุงุชู! ุชุญุฏู ูุงุนุจูู ุขุฎุฑูู ูู ูุถุน ุงูุฃูููุงูู ๐๐ฅ"**
5. **"ุงููุญูููู ููุชุธุฑููู! ุงูุนุจ ุฃูููุงูู ุงูุขู ูุงุฑุจุญ ุงููุฒูุฏ ูู ุงูููุงุท โฝ๐ช"**
6. **"ุญุงู ููุช ุงูููุงูุณุฉ! ุงูุนุจ ุฃูููุงูู ูุชุตุฏุฑ ูุงุฆูุฉ ุงููุชุตุฏุฑูู ๐โฝ"**

## ๐ง **ุงุณุชูุดุงู ุงูุฃุฎุทุงุก:**

### **ุฅุฐุง ูู ุชุตู ุงูุฅุดุนุงุฑุงุช:**
1. **ุชุฃูุฏ ูู ุชุญุฏูุซ ุงููุณุชุฎุฏููู** ุจุงุณุชุฎุฏุงู ุงูุฒุฑ ูู ุตูุญุฉ ุงูููู ุงูุดุฎุตู
2. **ุชุญูู ูู Firebase Console** โ Cloud Messaging โ Reports
3. **ุชุฃูุฏ ูู ุฅุฐู ุงูุฅุดุนุงุฑุงุช** ูู ุฅุนุฏุงุฏุงุช ุงููุงุชู
4. **ุชุญูู ูู FCM tokens** ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

### **ุณุฌูุงุช ูููุฏุฉ:**
```dart
// ูู ุงูุชุทุจูู ุณุชุฌุฏ ูุฐู ุงูุฑุณุงุฆู:
print('๐ ุชู ุฌูุจ ${tokens.length} FCM token ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช');
print('โ ุชู ุญูุธ FCM Token ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูููุณุชุฎุฏู: ${user.uid}');
print('๐ ุชู ุชุญุฏูุซ FCM Token: $newToken');
```

## ๐ **ุงููุชูุฌุฉ ุงูููุงุฆูุฉ:**

### **ุงูุขู ููููู:**
- โ **ุฅุฑุณุงู ุฅุดุนุงุฑุงุช ูุฌููุน ุงููุณุชุฎุฏููู** ุญุชู ูู ูุงู ุงูุชุทุจูู ูุบูู
- โ **ุชุชุจุน ุงูุฅุญุตุงุฆูุงุช** ูู Firebase Console
- โ **ุชุฎุตูุต ุงูุฅุดุนุงุฑุงุช** ุญุณุจ ุงููุณุชุฎุฏู ุฃู ุงููุฌููุนุฉ
- โ **ุฌุฏููุฉ ุงูุฅุดุนุงุฑุงุช** ุชููุงุฆูุงู

### **ุงููุธุงู ุฌุงูุฒ ููุงุณุชุฎุฏุงู!** ๐

**ุงูุฎุทูุงุช ุงูุชุงููุฉ:**
1. **ุดุบู ุงูุชุทุจูู** ูุญุฏุซ ุงููุณุชุฎุฏููู
2. **ุงุฐูุจ ุฅูู Firebase Console** ูุฃุฑุณู ุฅุดุนุงุฑ ุชุฌุฑูุจู
3. **ุงุฎุชุจุฑ ุนูู ุฃุฌูุฒุฉ ูุฎุชููุฉ** ููุชุฃูุฏ ูู ูุตูู ุงูุฅุดุนุงุฑุงุช
4. **ุงุจุฏุฃ ุฅุฑุณุงู ุงูุฅุดุนุงุฑุงุช** ูููุณุชุฎุฏููู! ๐ฎโจ
